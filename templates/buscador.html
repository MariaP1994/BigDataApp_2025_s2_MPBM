{% extends "base.html" %}

{% block title %}Buscador de documentos · BigData MPBM{% endblock %}

{% block extra_css %}
<style>
  .buscador-wrap { margin-top: 1.5rem; }
  .buscador-card {
    background: #f9fafb;
    border-radius: 18px;
    padding: 1.8rem 1.8rem 1.4rem 1.8rem;
    border: 1px solid #e5e7eb;
    box-shadow: 0 12px 30px rgba(0,0,0,.15);
  }
  .result-card {
    margin-top: 1.8rem;
    background: #ffffff;
    border-radius: 18px;
    padding: 1.2rem 1.5rem;
    border: 1px solid #e5e7eb;
    box-shadow: 0 10px 26px rgba(0,0,0,.12);
  }
  table thead th {
    background: #111827;
    color: #f9fafb;
  }
  .pdf-btn { padding: .25rem .6rem; font-size: .78rem; }
  .small-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e5e7eb;
  }
  #estadoBusqueda { font-size: .9rem; color:#6b7280; }
</style>
{% endblock %}

{% block content %}
<div class="container buscador-wrap">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold mb-0">Buscador de documentos</h2>
    <img src="{{ url_for('static', filename='Images/creador.png') }}"
         class="small-avatar"
         alt="María Paula Barrero">
  </div>

  <!-- FORMULARIO -->
  <div class="buscador-card">
    <form id="formBusqueda" onsubmit="buscarElastic(); return false;">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Texto a buscar</label>
          <input id="txtTexto" type="text" class="form-control"
                 placeholder="Ej: vigilancia, mortalidad, brotes...">
        </div>
        <div class="col-md-3">
          <label class="form-label">Año</label>
          <input id="txtAnio" type="number" min="2000" max="2100"
                 class="form-control" placeholder="Ej: 2019">
        </div>
        <div class="col-md-3">
          <label class="form-label">Semana epidemiológica</label>
          <input id="txtSemana" type="number" min="1" max="53"
                 class="form-control" placeholder="Ej: 29">
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <span id="estadoBusqueda"></span>
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search"></i> Buscar
        </button>
      </div>
    </form>
  </div>

  <!-- RESULTADOS -->
  <div id="divResultados" class="result-card" style="display:none;">
    <h5 class="mb-3">
      Resultados de la búsqueda (<span id="totalResultados">0</span>)
    </h5>

    <div class="table-responsive">
      <table class="table table-sm table-striped table-bordered align-middle">
        <thead>
          <tr>
            <th>Año</th>
            <th>Semana</th>
            <th>Rango de fechas</th>
            <th>Tema central</th>
            <th>Publicación en línea</th>
            <th>Temas de portada</th>
            <th>PDF</th>
          </tr>
        </thead>
        <tbody id="tablaResultados"></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function setEstado(msg) {
    document.getElementById("estadoBusqueda").textContent = msg || "";
  }

  function buscarElastic() {
    const texto  = document.getElementById("txtTexto").value.trim();
    const anio   = document.getElementById("txtAnio").value.trim();
    const semana = document.getElementById("txtSemana").value.trim();

    if (!texto && !anio && !semana) {
      alert("Debes ingresar al menos texto, año o semana.");
      return;
    }

    const payload = { texto, anio, semana };

    setEstado("Buscando...");
    console.log("ENVIANDO A /buscar-elastic:", payload);

    fetch("{{ url_for('buscar_elastic') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
      console.log("RESPUESTA /buscar-elastic:", data);
      if (!data.success) {
        setEstado("Error: " + (data.error || "Error desconocido"));
        alert("Error en la búsqueda: " + (data.error || "Error desconocido"));
        return;
      }

      setEstado("");
      const divResultados = document.getElementById("divResultados");
      const tabla         = document.getElementById("tablaResultados");
      const totalSpan     = document.getElementById("totalResultados");

      divResultados.style.display = "block";
      tabla.innerHTML = "";
      totalSpan.textContent = data.total || 0;

      if (!data.hits || data.hits.length === 0) {
        tabla.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron resultados</td></tr>';
        return;
      }

      data.hits.forEach(hit => {
        const d = hit._source || {};
        const anio    = d.anio ?? "-";
        const semana  = d.semana_epidemiologica ?? "-";
        const rango   = d.rango_fechas ?? "-";
        const tema    = d.tema_central ?? "(Sin tema)";
        const pub     = d.publicacion_en_linea ?? "(Sin información)";
        const temas   = Array.isArray(d.temas_portada)
                        ? d.temas_portada.join(", ")
                        : (d.temas_portada || "-");
        const pdf     = d.pdf_url || null;

        const fila = `
          <tr>
            <td>${anio}</td>
            <td>${semana}</td>
            <td>${rango}</td>
            <td>${tema}</td>
            <td>${pub}</td>
            <td>${temas}</td>
            <td class="text-center">
              ${pdf
                ? <a href="${pdf}" target="_blank" class="btn btn-sm btn-primary pdf-btn">Ver PDF</a>
                : <span class="text-muted">N/A</span>}
            </td>
          </tr>
        `;
        tabla.insertAdjacentHTML("beforeend", fila);
      });
    })
    .catch(err => {
      console.error("ERROR FETCH /buscar-elastic:", err);
      setEstado("Error al consultar Elastic.");
      alert("Error al consultar Elastic.");
    });
  }
</script>
{% endblock %}