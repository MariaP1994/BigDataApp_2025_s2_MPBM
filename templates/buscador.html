{% extends "base.html" %}

{% block title %}Buscador de documentos{% endblock %}

{% block extra_css %}
<style>
    .search-card {
        background: #ffffff;
        border-radius: 14px;
        padding: 2rem;
        box-shadow: 0 8px 25px rgba(0,0,0,.20);
        max-width: 900px;
        margin: 0 auto;
    }
    .result-card {
        background: #ffffff;
        border-radius: 14px;
        padding: 1.4rem;
        box-shadow: 0 8px 25px rgba(0,0,0,.15);
        max-width: 1100px;
        margin: 3rem auto;
    }
</style>
{% endblock %}

{% block content %}

<h2 class="text-center mb-4 fw-bold">Buscador de documentos</h2>

<div class="search-card">
    <form id="formBusqueda" onsubmit="buscarElastic(); return false;">
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Texto a buscar</label>
                <input id="texto" class="form-control" placeholder="Ej: comportamiento">
            </div>

            <div class="col-md-3">
                <label class="form-label">Año</label>
                <input id="anio" class="form-control" placeholder="Ej: 2019">
            </div>

            <div class="col-md-3">
                <label class="form-label">Semana epidemiológica</label>
                <input id="semana" class="form-control" placeholder="Ej: 29">
            </div>
        </div>

        <button class="btn btn-primary">
            <i class="bi bi-search"></i> Buscar
        </button>
    </form>
</div>

<div id="divResultados" class="result-card" style="display:none;">
    <h5 class="mb-3">Resultados de la búsqueda (<span id="totalResultados">0</span>)</span></h5>

    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Año</th>
                    <th>Semana</th>
                    <th>Tema central</th>
                    <th>Rango de fechas</th>
                    <th>Publicación en línea</th>
                    <th>PDF</th>
                </tr>
            </thead>
            <tbody id="tablaResultados"></tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
async function buscarElastic() {
    const texto  = document.getElementById("texto").value;
    const anio   = document.getElementById("anio").value;
    const semana = document.getElementById("semana").value;

    const resp = await fetch("/buscar-elastic", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({texto, anio, semana})
    });

    const data = await resp.json();
    console.log("RESPUESTA /buscar-elastic:", data);

    const divResultados = document.getElementById("divResultados");
    const totalSpan     = document.getElementById("totalResultados");
    const tbody         = document.getElementById("tablaResultados");

    tbody.innerHTML = "";
    divResultados.style.display = "block";

    if (!data.success || !data.hits || data.hits.length === 0) {
        totalSpan.textContent = "0";
        tbody.innerHTML = <tr><td colspan="6" class="text-center text-muted">Sin resultados</td></tr>;
        return;
    }

    totalSpan.textContent = data.total || data.hits.length;

    data.hits.forEach(hit => {
        const d = hit._source || {};

        const fila = `
            <tr>
                <td>${d.anio ?? ""}</td>
                <td>${d.semana_epidemiologica ?? ""}</td>
                <td>${d.tema_central ?? ""}</td>
                <td>${d.rango_fechas ?? ""}</td>
                <td>${d.publicacion_en_linea ? <a href="${d.publicacion_en_linea}" target="_blank">Ver</a> : ""}</td>
                <td>${d.pdf_url ? <a href="${d.pdf_url}" target="_blank" class="btn btn-sm btn-primary">PDF</a> : "N/A"}</td>
            </tr>
        `;

        tbody.insertAdjacentHTML("beforeend", fila);
    });
}
</script>
{% endblock %}