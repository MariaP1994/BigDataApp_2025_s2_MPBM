{% extends "base.html" %}

{% block title %}Buscador de documentos - BigData-MPBM{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #0f172a !important;
        color: #e5e7eb;
    }

    .search-card {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 18px;
        padding: 24px 24px 18px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: #e5e7eb;
    }

    .search-title {
        font-weight: 700;
        letter-spacing: .04em;
        text-transform: uppercase;
        font-size: .85rem;
        color: #a5b4fc;
    }

    .search-hero {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .search-subtitle {
        color: #9ca3af;
        font-size: .95rem;
    }

    .search-label {
        font-size: .8rem;
        text-transform: uppercase;
        letter-spacing: .06em;
        color: #9ca3af;
        margin-bottom: 4px;
    }

    .search-input {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.6);
        color: #e5e7eb;
    }

    .search-input:focus {
        background: rgba(15, 23, 42, 0.95);
        border-color: #22c55e;
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
        color: #e5e7eb;
    }

    .search-select {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.6);
        color: #e5e7eb;
    }

    .search-select option {
        color: #0f172a;
    }

    .btn-search-main {
        height: 100%;
        font-weight: 600;
        font-size: .95rem;
        border-radius: 999px;
    }

    .result-card {
        margin-top: 1.8rem;
        background: rgba(15, 23, 42, 0.92);
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
        color: #e5e7eb;
    }

    .result-header {
        border-bottom: 1px solid rgba(75, 85, 99, 0.7);
    }

    .badge-soft {
        background: rgba(34, 197, 94, 0.12);
        color: #bbf7d0;
        border-radius: 999px;
        padding: .15rem .7rem;
        font-size: .7rem;
    }

    .tabla-resultados {
        max-height: 520px;
        overflow-y: auto;
        border-radius: 14px;
    }

    .json-view {
        background-color: #020617;
        border-radius: .5rem;
        padding: .5rem .6rem;
        font-family: "JetBrains Mono", monospace;
        font-size: .74rem;
        white-space: pre-wrap;
        max-height: 170px;
        overflow-y: auto;
        color: #e5e7eb;
        border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .btn-link-detalle {
        font-size: .78rem;
        padding: 0;
    }

    .modal-content {
        background: #020617;
        color: #e5e7eb;
    }

    .modal-header,
    .modal-footer {
        border-color: #1f2937;
    }

    #div_cargando p {
        color: #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}

<!-- CABECERA -->
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <div class="search-title">Módulo de consulta</div>
            <h1 class="search-hero mb-1">Buscador de Boletines Epidemiológicos</h1>
            <p class="search-subtitle mb-0">
                Busca boletines indexados en ElasticSearch y filtra por texto, semana, año o tipo de archivo.
            </p>
        </div>

        <div class="text-end small text-white-50">
            Índice activo: <span class="badge-soft">{{ ELASTIC_INDEX_DEFAULT }}</span>
        </div>
    </div>
</div>

<!-- FORMULARIO -->
<div class="search-card mb-3">
    <form id="formBuscar" onsubmit="buscar(event)">
        <div class="row g-3 align-items-end">

            <div class="col-12 col-lg-6">
                <label class="search-label">Texto</label>
                <input type="text" class="form-control search-input" id="textoBuscar"
                       placeholder="COVID, dengue, mortalidad semanal, etc." required>
            </div>

            <div class="col-6 col-lg-2">
                <label class="search-label">Año</label>
                <input type="number" class="form-control search-input" id="anioFiltro"
                       min="2015" max="2030" placeholder="2022">
            </div>

            <div class="col-6 col-lg-2">
                <label class="search-label">Semana</label>
                <input type="number" class="form-control search-input" id="semanaFiltro"
                       min="1" max="53" placeholder="1-53">
            </div>

            <div class="col-12 col-lg-2">
                <label class="search-label">Tipo</label>
                <select id="tipoFiltro" class="form-select search-select">
                    <option value="">Todos</option>
                    <option value="pdf">PDF</option>
                    <option value="json">JSON</option>
                </select>
            </div>
        </div>

        <div class="row mt-3 align-items-center">
            <div class="col-md-8 small text-white-50">
                Puedes buscar por cualquier contenido del boletín: tema central, expertos, fechas, etc.
            </div>
            <div class="col-md-4 text-md-end mt-2 mt-md-0">
                <button class="btn btn-primary btn-search-main px-4">
                    <i class="bi bi-search me-1"></i> Buscar
                </button>
            </div>
        </div>
    </form>
</div>

<!-- LOADING -->
<div id="div_cargando" class="text-center mt-4" style="display:none;">
    <div class="spinner-border text-light"></div>
    <p class="mt-2">Buscando boletines...</p>
</div>

<!-- RESULTADOS -->
<div id="divResultados" style="display:none;">
    <div class="result-card">
        <div class="card-header result-header d-flex justify-content-between">
            <h5 class="mb-0">
                Resultados
                <span class="badge-soft ms-2">Total: <span id="totalResultados">0</span></span>
            </h5>
        </div>

        <div class="card-body">
            <div class="tabla-resultados">
                <table class="table table-dark table-striped table-hover mb-0 align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ID</th>
                            <th>Score</th>
                            <th>Semana</th>
                            <th>Año</th>
                            <th>Tema Central</th>
                            <th>Expertos</th>
                            <th>Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="tablaResultados"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ERROR -->
<div id="divError" class="alert alert-danger mt-4" style="display:none;">
    <strong>Error:</strong> <span id="mensajeError"></span>
</div>

<!-- MODAL DETALLE -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle del boletín</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalleBody"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let ultimaBusqueda = [];

// ---------------- BUSCAR ----------------
function buscar(event) {
    event.preventDefault();

    const texto = document.getElementById("textoBuscar").value.trim();
    const anio = document.getElementById("anioFiltro").value.trim();
    const semana = document.getElementById("semanaFiltro").value.trim();
    const tipo = document.getElementById("tipoFiltro").value.trim();

    if (!texto) {
        alert("Ingrese un texto para buscar");
        return;
    }

    document.getElementById("divResultados").style.display = "none";
    document.getElementById("divError").style.display = "none";
    document.getElementById("div_cargando").style.display = "block";

    fetch("/buscar-elastic", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            texto: texto,
            anio: anio || null,
            semana: semana || null,
            tipo_archivo: tipo || null
        })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById("div_cargando").style.display = "none";

        if (!data.success) {
            mostrarError(data.error || "Error desconocido");
            return;
        }

        mostrarResultados(data);
    })
    .catch(err => {
        document.getElementById("div_cargando").style.display = "none";
        mostrarError("Error de conexión o servidor");
    });
}

// ---------------- RESULTADOS ----------------
function mostrarResultados(data) {
    document.getElementById("totalResultados").textContent = data.total || 0;

    ultimaBusqueda = data.hits || [];
    const tabla = document.getElementById("tablaResultados");
    tabla.innerHTML = "";

    if (ultimaBusqueda.length === 0) {
        tabla.innerHTML = "<tr><td colspan='8' class='text-center'>No hay resultados</td></tr>";
    }

    ultimaBusqueda.forEach((hit, i) => {
        const src = hit._source || {};

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${i+1}</td>
            <td><code>${hit._id}</code></td>
            <td>${hit._score?.toFixed(4) ?? "N/A"}</td>
            <td>${src.semana_epidemiologica ?? "-"}</td>
            <td>${src.anio ?? "-"}</td>
            <td>${src.tema_central ?? "-"}</td>
            <td>${(src.expertos_tematicos || []).join(", ")}</td>
            <td>
                <button class="btn btn-sm btn-info" data-bs-toggle="modal"
                        data-bs-target="#modalDetalle"
                        onclick="mostrarDetalle(${i})">
                    Ver
                </button>
            </td>`;
        tabla.appendChild(row);
    });

    document.getElementById("divResultados").style.display = "block";
}

// ---------------- ERROR ----------------
function mostrarError(msg) {
    document.getElementById("mensajeError").textContent = msg;
    document.getElementById("divError").style.display = "block";
}

// ---------------- DETALLE ----------------
function mostrarDetalle(i) {
    const hit = ultimaBusqueda[i];
    const src = hit._source ?? {};

    document.getElementById("modalDetalleBody").innerHTML = `
        <pre class="json-view">${JSON.stringify(src, null, 2)}</pre>
    `;
}
</script>
{% endblock %}
