{% block extra_js %}
<script>
    let ultimaBusqueda = [];

    function buscar(event) {
        event.preventDefault();

        const texto   = document.getElementById("textoBuscar").value.trim();
        const anio    = document.getElementById("anioFiltro").value.trim();
        const semana  = document.getElementById("semanaFiltro").value.trim();
        const tipo    = document.getElementById("tipoFiltro").value;

        if (!texto) {
            alert("Ingrese un texto para buscar.");
            return;
        }

        document.getElementById("divResultados").style.display = "none";
        document.getElementById("divError").style.display = "none";
        document.getElementById("div_cargando").style.display = "block";

        fetch("/buscar-elastic", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                texto: texto,
                campo: "_all",
                anio: anio || null,
                semana: semana || null,
                tipo_archivo: tipo || null
            })
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById("div_cargando").style.display = "none";

            if (!data.success) {
                mostrarError(data.error || "Error desconocido.");
                return;
            }

            mostrarResultados(data);
        })
        .catch(err => {
            console.error(err);
            document.getElementById("div_cargando").style.display = "none";
            mostrarError("Error en la conexión.");
        });
    }

    function mostrarResultados(data) {
        document.getElementById("totalResultados").textContent = data.total || 0;

        mostrarAggregations(data.aggs || {});
        ultimaBusqueda = data.resultados || data.hits || [];
        mostrarHits(ultimaBusqueda);

        document.getElementById("divResultados").style.display = "block";
    }

    function mostrarAggregations(aggs) {
        const cont = document.getElementById("divAggregations");
        cont.innerHTML = "";

        if (!aggs || Object.keys(aggs).length === 0) {
            cont.innerHTML = "<p class='text-muted mb-0'>No hay facetas configuradas.</p>";
            return;
        }

        for (const [nombre, agg] of Object.entries(aggs)) {
            const div = document.createElement("div");
            div.className = "aggs-item";
            div.innerHTML =
                `<h6>${nombre}</h6>
                 <pre class="json-view mb-0">${JSON.stringify(agg, null, 2)}</pre>`;
            cont.appendChild(div);
        }
    }

    function mostrarHits(hits) {
        const tabla = document.getElementById("tablaResultados");
        tabla.innerHTML = "";

        if (!hits || hits.length === 0) {
            tabla.innerHTML =
                "<tr><td colspan='5' class='text-center text-muted'>No se encontraron resultados.</td></tr>";
            return;
        }

        hits.forEach((hit, i) => {
            const src = hit._source || {};

            const semana = src.semana_epidemiologica || "N/D";
            const rango  = src.rango_fechas || "N/D";
            const tema   = src.tema_central || "Sin tema central";
            const publi  = src.publicacion_en_linea || "";
            const pdfUrl = src.pdf_url || "";

            let temasPortadaTexto = "";
            if (Array.isArray(src.temas_portada) && src.temas_portada.length > 0) {
                temasPortadaTexto = src.temas_portada.join(" · ");
            } else if (typeof src.temas_portada === "string" && src.temas_portada.trim() !== "") {
                temasPortadaTexto = src.temas_portada;
            }

            let resumenHtml = `
                <strong>Semana epidemiológica:</strong> ${semana}<br>
                <strong>Rango de fechas:</strong> ${rango}<br>
                <strong>Tema central:</strong> ${tema}
            `;

            if (temasPortadaTexto) {
                resumenHtml += `<br><strong>Temas de portada:</strong> ${temasPortadaTexto}`;
            }

            if (publi) {
                resumenHtml += `<br><strong>Publicación en línea:</strong> ${publi}`;
            }

            if (pdfUrl) {
                resumenHtml += `<br><strong>PDF:</strong> 
                    <a href="${pdfUrl}" target="_blank" rel="noopener noreferrer">
                        Abrir boletín
                    </a>`;
            }

            const row = document.createElement("tr");
            row.innerHTML =
                "<td>" + (i + 1) + "</td>" +
                "<td><code class='small'>" + (hit._id || "") + "</code></td>" +
                "<td>" + (hit._score ? hit._score.toFixed(4) : "N/A") + "</td>" +
                "<td><small class='text-white-50'>" + (hit._index || "") + "</small></td>" +
                "<td>" +
                    "<div class='json-view mb-1'>" + resumenHtml + "</div>" +
                    "<button class='btn btn-link btn-link-detalle text-info' " +
                        "onclick='mostrarDetalle(" + i + ")' data-bs-toggle='modal' data-bs-target='#modalDetalle'>" +
                        "<i class='bi bi-arrows-angle-expand me-1'></i>Ver JSON completo" +
                    "</button>" +
                "</td>";

            tabla.appendChild(row);
        });
    }

    function mostrarError(msg) {
        document.getElementById("mensajeError").textContent = msg;
        document.getElementById("divError").style.display = "block";
    }

    function mostrarDetalle(i) {
        const hit = ultimaBusqueda[i];
        if (!hit) return;

        const modalBody = document.getElementById("modalDetalleBody");
        modalBody.innerHTML =
            "<pre class='json-view' style='max-height:520px;overflow-y:auto;'>" +
            JSON.stringify(hit._source || {}, null, 2) +
            "</pre>";
    }
</script>
{% endblock %}
