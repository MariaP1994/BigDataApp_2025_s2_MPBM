{% extends "base.html" %}

{% block title %}Gestor de ElasticSearch - BigData-MiProyecto{% endblock %}

{% block extra_css %}
<style>
    .page-subtitle {
        font-size: .95rem;
        color: #9ca3af;
        max-width: 720px;
    }

    .badge-user {
        background: rgba(34, 197, 94, 0.1);
        color: #bbf7d0;
        border-radius: 999px;
        padding: .25rem .75rem;
        font-size: .75rem;
    }

    .panel-card {
        background: rgba(15, 23, 42, 0.92);
        border-radius: 18px;
        padding: 18px 20px 16px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: #e5e7eb;
        margin-bottom: 1.25rem;
    }

    .panel-card h5 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: .4rem;
    }

    .step-pill {
        font-size: .7rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #9ca3af;
        margin-bottom: .35rem;
    }

    .query-result {
        max-height: 600px;
        overflow-y: auto;
    }

    .json-view {
        background-color: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(55, 65, 81, 0.9);
        border-radius: 0.75rem;
        padding: 0.75rem;
        font-family: "JetBrains Mono", "Courier New", monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: #e5e7eb;
    }

    .table-dark thead th {
        border-color: #374151;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(15, 23, 42, 0.9);
    }

    .badge-soft-green {
        background: rgba(34, 197, 94, 0.18);
        color: #bbf7d0;
        border-radius: 999px;
        font-size: .7rem;
        padding: .15rem .6rem;
    }

    .badge-soft-yellow {
        background: rgba(234, 179, 8, 0.18);
        color: #facc15;
        border-radius: 999px;
        font-size: .7rem;
        padding: .15rem .6rem;
    }

    .badge-soft-red {
        background: rgba(248, 113, 113, 0.18);
        color: #fecaca;
        border-radius: 999px;
        font-size: .7rem;
        padding: .15rem .6rem;
    }

    .badge-soft-muted {
        background: rgba(148, 163, 184, 0.25);
        color: #e5e7eb;
        border-radius: 999px;
        font-size: .7rem;
        padding: .15rem .6rem;
    }

    .code-hint {
        font-size: .78rem;
        color: #9ca3af;
    }
</style>
{% endblock %}


{% block content %}

<!-- CABECERA DE LA PÁGINA -->
<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
    <div>
        <div class="step-pill">Módulo avanzado · ElasticSearch</div>
        <h1 class="mb-1">Gestión de índices y consultas</h1>
        <p class="page-subtitle mb-0">
            Desde este panel puedes revisar el estado de los índices de ElasticSearch, monitorear su salud
            y ejecutar consultas o comandos JSON para explorar o modificar datos de forma controlada.
        </p>
    </div>
    <div class="text-end">
        <div class="badge-user mb-1">
            <i class="bi bi-person-circle me-1"></i> {{ usuario }}
        </div>
        <div class="mt-2">
            <a href="{{ url_for('admin') }}" class="btn btn-outline-light btn-sm me-1">
                <i class="bi bi-speedometer2 me-1"></i> Volver al panel
            </a>
            <a href="{{ url_for('landing') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-box-arrow-right me-1"></i> Salir
            </a>
        </div>
    </div>
</div>

<!-- 1. TABLA DE ÍNDICES -->
<div class="panel-card">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <div class="step-pill">Vista general</div>
            <h5>Índices de ElasticSearch</h5>
        </div>
        <button class="btn btn-outline-light btn-sm" type="button" onclick="cargarIndices()">
            <i class="bi bi-arrow-repeat me-1"></i> Actualizar
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-dark table-striped table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th>Nombre del índice</th>
                    <th>Total documentos</th>
                    <th>Tamaño</th>
                    <th>Salud</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody id="tablaIndices">
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                        Cargando índices...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 2. FORMULARIO DE CONSULTAS -->
<div class="panel-card">
    <div class="step-pill">Operaciones</div>
    <h5>Ejecutar consulta o comando JSON</h5>

    <form id="formElasticQuery" class="mt-2">
        <div class="mb-3">
            <label class="form-label">Tipo de operación</label>
            <div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio"
                           name="tipo_operacion" id="radioQuery" value="QUERY" checked>
                    <label class="form-check-label" for="radioQuery">QUERY (búsqueda / aggregations)</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio"
                           name="tipo_operacion" id="radioDML" value="DML">
                    <label class="form-check-label" for="radioDML">DML (indexar / update / delete)</label>
                </div>
            </div>
        </div>

        <div class="mb-2">
            <label for="queryTextarea" class="form-label">Query / Comando (JSON)</label>
            <textarea class="form-control" id="queryTextarea" name="query" rows="10" required
                      placeholder='Ejemplo QUERY:
{
  "index": "indice-boletin-semanal",
  "query": {
    "match_all": {}
  },
  "size": 10
}

Ejemplo DML:
{
  "operacion": "index",
  "index": "indice-boletin-semanal",
  "id": "1",
  "documento": {
    "campo": "valor"
  }
}'></textarea>
            <div class="code-hint mt-1">
                Asegúrate de que el contenido sea un JSON válido.  
                La API del backend espera exactamente esa estructura para cada tipo de operación.
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                <i class="bi bi-x-circle me-1"></i> Limpiar
            </button>
            <button type="button" class="btn btn-primary" onclick="ejecutarComando()">
                <i class="bi bi-play-circle me-1"></i> Ejecutar
            </button>
        </div>
    </form>
</div>

<!-- 3A. RESULTADOS DE QUERY -->
<div id="divResultadosQuery" style="display: none;">
    <div class="panel-card">
        <div class="step-pill">Resultados</div>
        <h5>Respuesta de la consulta (QUERY)</h5>

        <div class="row mt-2">
            <!-- Aggregations -->
            <div class="col-md-6 mb-3">
                <h6 class="mb-2">Aggregations</h6>
                <div id="divAggregations" class="json-view query-result">
                    No hay aggregations en esta consulta
                </div>
            </div>

            <!-- Hits -->
            <div class="col-md-6 mb-3">
                <h6 class="mb-2">
                    Resultados (hits) · Total: <span id="totalHits">0</span>
                </h6>
                <div class="table-responsive query-result">
                    <table class="table table-sm table-dark table-striped table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Índice</th>
                                <th>Score</th>
                                <th>Datos</th>
                            </tr>
                        </thead>
                        <tbody id="tablaHits"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3B. RESULTADOS DE DML -->
<div id="divResultadosDML" style="display: none;">
    <div class="panel-card">
        <div class="step-pill">Resultados</div>
        <h5>Resultado del comando DML</h5>

        <div id="divResultadoDML" class="json-view mt-2"></div>
    </div>
</div>

<!-- SPINNER GLOBAL -->
<div id="div_cargando" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2" id="mensaje_cargando">Procesando su solicitud...</p>
</div>

{% endblock %}


{% block extra_js %}
<script>
    // Cargar índices al iniciar
    document.addEventListener('DOMContentLoaded', function () {
        cargarIndices();
    });

    function cargarIndices() {
        document.getElementById('div_cargando').style.display = 'block';

        fetch('/listar-indices-elastic')
            .then(response => response.json())
            .then(data => {
                const tablaIndices = document.getElementById('tablaIndices');
                tablaIndices.innerHTML = '';

                if (!data || data.length === 0) {
                    tablaIndices.innerHTML =
                        '<tr><td colspan="5" class="text-center text-muted py-3">No hay índices disponibles</td></tr>';
                } else {
                    data.forEach(indice => {
                        const row = document.createElement('tr');

                        // Badge salud
                        const salud = indice.salud || 'unknown';
                        let saludBadge = '';
                        if (salud === 'green') {
                            saludBadge = '<span class="badge-soft-green">Verde</span>';
                        } else if (salud === 'yellow') {
                            saludBadge = '<span class="badge-soft-yellow">Amarillo</span>';
                        } else if (salud === 'red') {
                            saludBadge = '<span class="badge-soft-red">Rojo</span>';
                        } else {
                            saludBadge = '<span class="badge-soft-muted">Desconocido</span>';
                        }

                        // Badge estado
                        const estado = indice.estado || 'unknown';
                        let estadoBadge = '';
                        if (estado === 'open') {
                            estadoBadge = '<span class="badge-soft-green">Abierto</span>';
                        } else {
                            estadoBadge = '<span class="badge-soft-muted">Cerrado</span>';
                        }

                        row.innerHTML = `
                            <td><strong>${indice.nombre || ''}</strong></td>
                            <td>${indice.total_documentos || 0}</td>
                            <td>${indice.tamaño || '0b'}</td>
                            <td>${saludBadge}</td>
                            <td>${estadoBadge}</td>
                        `;
                        tablaIndices.appendChild(row);
                    });
                }

                document.getElementById('div_cargando').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar la lista de índices');
                document.getElementById('div_cargando').style.display = 'none';
            });
    }

    function ejecutarComando() {
        const tipoOperacion = document.querySelector('input[name="tipo_operacion"]:checked').value;
        const queryText = document.getElementById('queryTextarea').value.trim();

        if (!queryText) {
            alert('Por favor, ingrese una query o comando');
            return;
        }

        try {
            JSON.parse(queryText);
        } catch (e) {
            alert('Error: el texto ingresado no es un JSON válido.\n' + e.message);
            return;
        }

        document.getElementById('div_cargando').style.display = 'block';
        document.getElementById('divResultadosQuery').style.display = 'none';
        document.getElementById('divResultadosDML').style.display = 'none';

        if (tipoOperacion === 'QUERY') {
            ejecutarQuery(queryText);
        } else {
            ejecutarDML(queryText);
        }
    }

    function ejecutarQuery(queryText) {
        fetch('/ejecutar-query-elastic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: queryText })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('div_cargando').style.display = 'none';

            if (data.success) {
                document.getElementById('divResultadosQuery').style.display = 'block';

                document.getElementById('totalHits').textContent = data.total || 0;

                const divAggs = document.getElementById('divAggregations');
                if (data.aggs && Object.keys(data.aggs).length > 0) {
                    divAggs.textContent = JSON.stringify(data.aggs, null, 2);
                } else {
                    divAggs.textContent = 'No hay aggregations en esta consulta';
                }

                const tablaHits = document.getElementById('tablaHits');
                tablaHits.innerHTML = '';

                if (data.hits && data.hits.length > 0) {
                    data.hits.forEach(hit => {
                        const row = document.createElement('tr');
                        const source = hit._source || {};

                        row.innerHTML = `
                            <td>${hit._id || ''}</td>
                            <td>${hit._index || ''}</td>
                            <td>${hit._score ? hit._score.toFixed(4) : 'N/A'}</td>
                            <td>
                                <pre class="mb-0" style="font-size: 0.75rem; max-height: 180px; overflow-y: auto;">
${JSON.stringify(source, null, 2)}
                                </pre>
                            </td>
                        `;
                        tablaHits.appendChild(row);
                    });
                } else {
                    tablaHits.innerHTML =
                        '<tr><td colspan="4" class="text-center text-muted py-2">No hay resultados</td></tr>';
                }
            } else {
                alert('Error al ejecutar la query: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('div_cargando').style.display = 'none';
            alert('Error al ejecutar la query');
        });
    }

    function ejecutarDML(queryText) {
        fetch('/ejecutar-dml-elastic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ comando: queryText })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('div_cargando').style.display = 'none';

            if (data.success) {
                document.getElementById('divResultadosDML').style.display = 'block';
                const divResultado = document.getElementById('divResultadoDML');
                divResultado.textContent = JSON.stringify(data.data, null, 2);

                setTimeout(() => { cargarIndices(); }, 1000);
            } else {
                alert('Error al ejecutar el comando DML: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('div_cargando').style.display = 'none';
            alert('Error al ejecutar el comando DML');
        });
    }

    function limpiarFormulario() {
        document.getElementById('queryTextarea').value = '';
        document.getElementById('divResultadosQuery').style.display = 'none';
        document.getElementById('divResultadosDML').style.display = 'none';
    }
</script>
{% endblock %}
