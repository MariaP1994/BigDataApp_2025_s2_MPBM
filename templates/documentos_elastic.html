{% extends "base.html" %}

{% block title %}Cargar documentos a ElasticSearch - BigData-MiProyecto{% endblock %}

{% block extra_css %}
<style>
    .page-subtitle {
        font-size: .95rem;
        color: #9ca3af;
        max-width: 720px;
    }

    .badge-user {
        background: rgba(34, 197, 94, 0.1);
        color: #bbf7d0;
        border-radius: 999px;
        padding: .25rem .75rem;
        font-size: .75rem;
    }

    .panel-card {
        background: rgba(15, 23, 42, 0.92);
        border-radius: 18px;
        padding: 18px 20px 16px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: #e5e7eb;
        margin-bottom: 1.25rem;
    }

    .panel-card h5 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: .4rem;
    }

    .step-pill {
        font-size: .7rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #9ca3af;
        margin-bottom: .35rem;
    }

    .form-control,
    .form-select {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.6);
        color: #e5e7eb;
    }

    .form-control:focus,
    .form-select:focus {
        background: rgba(15, 23, 42, 0.98);
        border-color: #22c55e;
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
        color: #e5e7eb;
    }

    .form-text {
        color: #9ca3af !important;
        font-size: .78rem;
    }

    .table-dark thead th {
        border-color: #374151;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(15, 23, 42, 0.9);
    }

    .badge-soft-secondary {
        background: rgba(148, 163, 184, 0.2);
        color: #e5e7eb;
        border-radius: 999px;
        font-size: .7rem;
        padding: .15rem .6rem;
    }

    .badge-soft-warning {
        background: rgba(234, 179, 8, 0.18);
        color: #facc15;
        border-radius: 999px;
        font-size: .7rem;
        padding: .15rem .6rem;
    }

    .badge-soft-success {
        background: rgba(34, 197, 94, 0.18);
        color: #bbf7d0;
        border-radius: 999px;
        font-size: .7rem;
        padding: .15rem .6rem;
    }

    #info_resultados {
        background: rgba(15, 23, 42, 0.95);
        border-color: rgba(59, 130, 246, 0.4);
        color: #dbeafe;
    }

    #div_cargando p {
        color: #e5e7eb;
    }
</style>
{% endblock %}


{% block content %}

<!-- CABECERA DE LA PÁGINA -->
<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
    <div>
        <div class="step-pill">Módulo de ingestión de datos</div>
        <h1 class="mb-1">Cargar documentos a ElasticSearch</h1>
        <p class="page-subtitle mb-0">
            Desde aquí puedes seleccionar un índice de ElasticSearch y cargar documentos ya procesados en JSON (ZIP),
            o iniciar un flujo de Web Scraping para descargar archivos desde la web y prepararlos para su posterior indexación.
        </p>
    </div>
    <div class="text-end">
        <div class="badge-user mb-1">
            <i class="bi bi-person-circle me-1"></i> {{ usuario }}
        </div>
        <div class="mt-2">
            <a href="{{ url_for('admin') }}" class="btn btn-outline-light btn-sm me-1">
                <i class="bi bi-speedometer2 me-1"></i> Volver al panel
            </a>
            <a href="{{ url_for('landing') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-box-arrow-right me-1"></i> Salir
            </a>
        </div>
    </div>
</div>


<!-- 1. SELECCIÓN DE ÍNDICE -->
<div class="panel-card">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <div class="step-pill">Paso 1</div>
            <h5>Seleccionar índice de destino</h5>
        </div>
        <small class="text-white-50">
            ElasticSearch Cloud · índices disponibles
        </small>
    </div>

    <div class="mb-2">
        <label for="select_index" class="form-label">Índice de ElasticSearch</label>
        <select class="form-select" id="select_index" name="select_index">
            <option value="">Cargando índices...</option>
        </select>
    </div>
    <div class="form-text">
        Escoge el índice donde se almacenarán los documentos procesados.  
        El contador de documentos se actualizará automáticamente después de cada carga exitosa.
    </div>
</div>


<!-- 2. MÉTODO DE CARGA -->
<div class="panel-card">
    <div class="step-pill">Paso 2</div>
    <h5>Seleccionar método de carga</h5>

    <div class="row gy-2 mt-1">
        <div class="col-md-6">
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="metodo_carga"
                       id="radio_zip" value="zip" checked>
                <label class="form-check-label" for="radio_zip">
                    <strong>ZIP con JSON</strong>
                    <span class="d-block small text-white-50">
                        Utiliza esta opción cuando ya tengas documentos JSON preparados (estructura lista para indexación).
                    </span>
                </label>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="metodo_carga"
                       id="radio_webscraping" value="webscraping">
                <label class="form-check-label" for="radio_webscraping">
                    <strong>Web Scraping</strong>
                    <span class="d-block small text-white-50">
                        Explora una URL, descarga archivos (ej. PDFs) y déjalos listos para un flujo de PLN posterior.
                    </span>
                </label>
            </div>
        </div>
    </div>
</div>


<!-- 3A. OPCIÓN ZIP -->
<div class="panel-card" id="opciones_zip">
    <div class="step-pill">Paso 3 · Opción ZIP</div>
    <h5>Cargar archivo ZIP con JSON</h5>

    <div class="mb-3 mt-2">
        <label for="file_zip" class="form-label">Seleccionar archivo ZIP</label>
        <input type="file" class="form-control" id="file_zip" accept=".zip">
        <div class="form-text">
            El archivo ZIP debe contener uno o varios archivos <code>.json</code>
            con el contenido listo para indexarse en ElasticSearch.
        </div>
    </div>

    <button type="button" class="btn btn-primary" onclick="procesarZip()">
        <i class="bi bi-upload me-1"></i> Procesar ZIP
    </button>
</div>


<!-- 3B. OPCIÓN WEB SCRAPING -->
<div class="panel-card" id="opciones_webscraping" style="display: none;">
    <div class="step-pill">Paso 3 · Opción Web Scraping</div>
    <h5>Configurar extracción desde la web</h5>

    <div class="mb-3 mt-2">
        <label for="url_webscraping" class="form-label">URL inicial</label>
        <input type="url" class="form-control" id="url_webscraping"
               placeholder="https://ejemplo.com/seccion/boletines">
        <div class="form-text">
            Se navegará desde esta URL para extraer enlaces que cumplan con las extensiones definidas.
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <label for="extensiones_navegar" class="form-label">Extensiones a navegar</label>
            <input type="text" class="form-control" id="extensiones_navegar"
                   placeholder="aspx, php, html" value="aspx">
            <div class="form-text">
                Extensiones de páginas a seguir durante el rastreo.  
                Ejemplo: <code>aspx, php, html</code>
            </div>
        </div>

        <div class="col-md-6">
            <label for="tipos_archivos" class="form-label">Tipos de archivos a descargar</label>
            <input type="text" class="form-control" id="tipos_archivos"
                   placeholder="pdf, txt, docx" value="pdf">
            <div class="form-text">
                Tipos de archivos finales que se descargarán.  
                Ejemplo: <code>pdf, txt, doc</code>
            </div>
        </div>
    </div>

    <button type="button" class="btn btn-primary mt-3" onclick="procesarWebScraping()">
        <i class="bi bi-download me-1"></i> Iniciar Web Scraping
    </button>
</div>


<!-- 4. RESULTADOS Y ARCHIVOS -->
<div id="seccion_resultados" style="display: none;">
    <div class="panel-card">
        <div class="step-pill">Paso 4</div>
        <h5>Archivos procesados</h5>

        <div id="info_resultados" class="alert alert-info mb-3"></div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="seleccionar_todos"
                       onchange="toggleSeleccionarTodos()">
                <label class="form-check-label" for="seleccionar_todos">
                    Seleccionar todos
                </label>
            </div>
            <button type="button" class="btn btn-success" id="btn_cargar_seleccionados"
                    onclick="cargarSeleccionados()">
                <i class="bi bi-cloud-upload me-1"></i>
                <span id="texto_boton_cargar">Cargar seleccionados</span>
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="check_header" onchange="toggleSeleccionarTodos()">
                        </th>
                        <th>Archivo</th>
                        <th width="100">Tipo</th>
                        <th width="120">Tamaño</th>
                        <th width="130">Estado</th>
                    </tr>
                </thead>
                <tbody id="tabla_archivos">
                    <!-- Se llena por JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- SPINNER GLOBAL -->
<div id="div_cargando" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2" id="mensaje_cargando">Procesando su solicitud...</p>
</div>

{% endblock %}



{% block extra_js %}
<script>
    let archivosActuales = [];
    let metodoActual = 'zip';

    document.addEventListener('DOMContentLoaded', function() {
        cargarIndices();
        configurarRadioButtons();
    });

    function configurarRadioButtons() {
        document.querySelectorAll('input[name="metodo_carga"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'zip') {
                    document.getElementById('opciones_zip').style.display = 'block';
                    document.getElementById('opciones_webscraping').style.display = 'none';
                    metodoActual = 'zip';
                } else {
                    document.getElementById('opciones_zip').style.display = 'none';
                    document.getElementById('opciones_webscraping').style.display = 'block';
                    metodoActual = 'webscraping';
                }
                document.getElementById('seccion_resultados').style.display = 'none';
            });
        });
    }

    function cargarIndices() {
        fetch('/listar-indices-elastic')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('select_index');
                select.innerHTML = '<option value="">Seleccione un índice</option>';

                data.forEach(indice => {
                    const option = document.createElement('option');
                    option.value = indice.nombre;
                    option.textContent = `${indice.nombre} (${indice.total_documentos} docs)`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('select_index').innerHTML =
                    '<option value="">Error al cargar índices</option>';
            });
    }

    function procesarZip() {
        const fileInput = document.getElementById('file_zip');
        const selectIndex = document.getElementById('select_index');

        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Por favor, seleccione un archivo ZIP');
            return;
        }

        if (!selectIndex.value) {
            alert('Por favor, seleccione un índice de destino');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('index', selectIndex.value);

        mostrarCargando('Procesando archivo ZIP...');

        fetch('/procesar-zip-elastic', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            ocultarCargando();

            if (data.success) {
                archivosActuales = data.archivos;
                mostrarResultados(data);
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            ocultarCargando();
            console.error('Error:', error);
            alert('Error al procesar ZIP');
        });
    }

    function procesarWebScraping() {
        const url = document.getElementById('url_webscraping').value.trim();
        const extensionesNavegar = document.getElementById('extensiones_navegar').value.trim();
        const tiposArchivos = document.getElementById('tipos_archivos').value.trim();
        const selectIndex = document.getElementById('select_index');

        if (!url) {
            alert('Por favor, ingrese una URL');
            return;
        }

        if (!selectIndex.value) {
            alert('Por favor, seleccione un índice de destino');
            return;
        }

        mostrarCargando('Realizando Web Scraping... Esto puede tardar algunos minutos.');

        fetch('/procesar-webscraping-elastic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: url,
                extensiones_navegar: extensionesNavegar,
                tipos_archivos: tiposArchivos,
                index: selectIndex.value
            })
        })
        .then(r => r.json())
        .then(data => {
            ocultarCargando();

            if (data.success) {
                archivosActuales = data.archivos;
                mostrarResultados(data);
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            ocultarCargando();
            console.error('Error:', error);
            alert('Error al procesar Web Scraping');
        });
    }

    function mostrarResultados(data) {
        document.getElementById('seccion_resultados').style.display = 'block';

        let infoHtml = `<strong>Total de archivos:</strong> ${data.archivos.length}`;
        if (data.mensaje) {
            infoHtml += `<br>${data.mensaje}`;
        }
        if (data.stats) {
            infoHtml += `<br><small>Enlaces: ${data.stats.total_enlaces || 0}, `
                     +  `Descargados: ${data.stats.descargados || 0}, `
                     +  `Errores: ${data.stats.errores || 0}</small>`;
        }
        document.getElementById('info_resultados').innerHTML = infoHtml;

        if (metodoActual === 'webscraping') {
            document.getElementById('texto_boton_cargar').textContent =
                'PLN / Cargar seleccionados (futuro flujo)';
        } else {
            document.getElementById('texto_boton_cargar').textContent =
                'Cargar seleccionados';
        }

        const tbody = document.getElementById('tabla_archivos');
        tbody.innerHTML = '';

        data.archivos.forEach((archivo, index) => {
            // tamaño puede venir como "tamano" o "tamaño"
            const sizeBytes = archivo.tamano ?? archivo["tamaño"] ?? 0;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="archivo-checkbox"
                           data-index="${index}" checked>
                </td>
                <td>${archivo.nombre}</td>
                <td><span class="badge-soft-secondary">${archivo.extension || 'json'}</span></td>
                <td>${formatearTamaño(sizeBytes)}</td>
                <td><span class="badge-soft-warning">Pendiente</span></td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('seccion_resultados')
            .scrollIntoView({ behavior: 'smooth' });
    }

    function cargarSeleccionados() {
        const checkboxes = document.querySelectorAll('.archivo-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Por favor, seleccione al menos un archivo');
            return;
        }

        const selectIndex = document.getElementById('select_index');
        if (!selectIndex.value) {
            alert('Por favor, seleccione un índice de destino');
            return;
        }

        if (metodoActual === 'webscraping') {
            alert('Por ahora la carga a Elastic está implementada solo para ZIP con JSON.\n' +
                  'Los archivos descargados por Web Scraping se usarán en un flujo de PLN posterior.');
            return;
        }

        const indicesSeleccionados = Array.from(checkboxes)
            .map(cb => parseInt(cb.dataset.index, 10));
        const archivosSeleccionados = indicesSeleccionados
            .map(i => archivosActuales[i]);

        mostrarCargando('Cargando documentos a ElasticSearch...');

        fetch('/cargar-documentos-elastic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                archivos: archivosSeleccionados,
                index: selectIndex.value,
                metodo: metodoActual
            })
        })
        .then(r => r.json())
        .then(data => {
            ocultarCargando();

            if (data.success) {
                alert(`Carga completada:\n- Documentos indexados: ${data.indexados}\n- Errores: ${data.errores}`);

                checkboxes.forEach(cb => {
                    const row = cb.closest('tr');
                    const badge = row.querySelector('td:last-child span');
                    badge.className = 'badge-soft-success';
                    badge.textContent = 'Cargado';
                    cb.disabled = true;
                });

                cargarIndices();
            } else {
                alert('Error al cargar documentos: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            ocultarCargando();
            console.error('Error:', error);
            alert('Error al cargar documentos');
        });
    }

    function toggleSeleccionarTodos() {
        const checkHeader = document.getElementById('check_header');
        const checkTodos = document.getElementById('seleccionar_todos');
        const checkboxes = document.querySelectorAll('.archivo-checkbox:not(:disabled)');

        if (checkHeader && checkTodos) {
            checkTodos.checked = checkHeader.checked;
        }

        const estado = (checkHeader && checkHeader.checked) ||
                       (checkTodos && checkTodos.checked);

        checkboxes.forEach(cb => cb.checked = estado);
    }

    function formatearTamaño(bytes) {
        if (!bytes || bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        const valor = bytes / Math.pow(k, i);
        return valor.toFixed(2) + ' ' + sizes[i];
    }

    function mostrarCargando(mensaje) {
        const div = document.getElementById('div_cargando');
        const p = document.getElementById('mensaje_cargando');
        if (p && mensaje) {
            p.textContent = mensaje;
        }
        if (div) {
            div.style.display = 'block';
        }
    }

    function ocultarCargando() {
        const div = document.getElementById('div_cargando');
        if (div) {
            div.style.display = 'none';
        }
    }
</script>
{% endblock %}
